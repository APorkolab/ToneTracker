name: ðŸš€ ToneTracker CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Quality Checks
  quality:
    runs-on: ubuntu-latest
    name: ðŸ” Code Quality & Testing
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“š Install dependencies
      run: npm ci
      
    - name: ðŸ” Run ESLint
      run: npm run lint
      
    - name: ðŸŽ¨ Check code formatting
      run: npm run format -- --check
      
    - name: ðŸ§ª Run unit tests
      run: npm run test:run
      
    - name: ðŸ“Š Generate test coverage
      run: npm run test:coverage
      
    - name: ðŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage/lcov.info
        
    - name: ðŸ”’ Security audit
      run: npm audit --omit=dev
      continue-on-error: true

  # Performance & E2E Tests
  e2e:
    runs-on: ubuntu-latest
    name: ðŸŽ­ E2E & Performance Tests
    needs: quality
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“š Install dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build application
      run: npm run build
      
    - name: ðŸŽ­ Install Playwright
      run: npm run e2e:install
      
    - name: ðŸ§ª Run E2E tests
      run: npm run e2e
      
    - name: ðŸ“± Upload E2E artifacts
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

  # Build & Deploy
  deploy:
    runs-on: ubuntu-latest
    name: ðŸš€ Build & Deploy
    needs: [quality, e2e]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“š Install dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build for production
      run: npm run build
      env:
        NODE_ENV: production
        
    - name: ðŸ“Š Analyze bundle size
      run: |
        npx bundlesize
        echo "## Bundle Size Analysis ðŸ“¦" >> $GITHUB_STEP_SUMMARY
        du -sh dist/* >> $GITHUB_STEP_SUMMARY
      continue-on-error: true
      
    - name: ðŸ” Run Lighthouse audit
      run: |
        npm run serve &
        sleep 5
        npm run performance:audit
        pkill -f "python3 -m http.server"
      continue-on-error: true
      
    - name: ðŸ“± Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        cname: tonetracker.app # Optional: custom domain
        
    - name: ðŸ“ˆ Upload build artifacts
      uses: actions/upload-artifact@v3
      with:
        name: dist
        path: dist/
        retention-days: 30
        
    - name: ðŸ“Š Upload Lighthouse report
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: lighthouse-report
        path: lighthouse-report.html
        retention-days: 7

  # Notify deployment status
  notify:
    runs-on: ubuntu-latest
    name: ðŸ“¢ Deployment Notification
    needs: [deploy]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸŽ‰ Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "## âœ… Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "ToneTracker has been successfully deployed to production." >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Live URL: https://tonetracker.app" >> $GITHUB_STEP_SUMMARY
        
    - name: âŒ Failure notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "## âŒ Deployment Failed ðŸ’¥" >> $GITHUB_STEP_SUMMARY
        echo "Please check the deployment logs and fix any issues." >> $GITHUB_STEP_SUMMARY

# Performance budgets
bundlesize:
  - path: "dist/assets/*.js"
    maxSize: "250kb"
    compression: gzip
  - path: "dist/assets/*.css"
    maxSize: "50kb"
    compression: gzip
