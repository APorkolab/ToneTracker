name: ðŸš€ ToneTracker CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Quality Checks
  quality:
    runs-on: ubuntu-latest
    name: ðŸ” Code Quality & Testing
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“š Install dependencies
      run: npm ci
      
    - name: ðŸ” Run ESLint
      run: npm run lint
      
    - name: ðŸŽ¨ Check code formatting
      run: npm run format -- --check
      
    - name: ðŸ§ª Run unit tests
      run: npm run test:run
      
    - name: ðŸ“Š Generate test coverage
      run: npm run test:coverage
      
    - name: ðŸ“ˆ Upload coverage to Codecov
      uses: codecov/codecov-action@v4
      continue-on-error: true
      with:
        file: ./coverage/lcov.info
        token: ${{ secrets.CODECOV_TOKEN }}
        
    - name: ðŸ”’ Security audit
      run: npm audit --omit=dev
      continue-on-error: true

  # Performance & E2E Tests
  e2e:
    runs-on: ubuntu-latest
    name: ðŸŽ­ E2E & Performance Tests
    needs: quality
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“š Install dependencies
      run: npm ci
      
    - name: ðŸ—ï¸ Build application
      run: npm run build
      
    - name: ðŸŽ­ Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: ðŸ§ª Run E2E tests
      run: npm run e2e
      
    - name: ðŸ“± Upload E2E artifacts
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: playwright-report
        path: playwright-report/
        retention-days: 7

  # Build & Deploy
  deploy:
    runs-on: ubuntu-latest
    name: ðŸš€ Build & Deploy
    needs: [quality, e2e]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: ðŸ“š Install dependencies
      run: npm ci
      
    - name: ðŸŒ Install Chrome for Lighthouse
      run: |
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
      
    - name: ðŸ—ï¸ Build for production
      run: npm run build
      env:
        NODE_ENV: production
        
    - name: ðŸ“‹ Copy CNAME file to dist
      run: cp CNAME dist/
      
    - name: âœ… Validate build output
      run: |
        echo "## Build Validation ðŸ”" >> $GITHUB_STEP_SUMMARY
        echo "### Files in dist directory:" >> $GITHUB_STEP_SUMMARY
        ls -la dist/ >> $GITHUB_STEP_SUMMARY
        echo "### Checking required files:" >> $GITHUB_STEP_SUMMARY
        test -f dist/index.html && echo "âœ… index.html exists" >> $GITHUB_STEP_SUMMARY || echo "âŒ index.html missing" >> $GITHUB_STEP_SUMMARY
        test -f dist/CNAME && echo "âœ… CNAME exists" >> $GITHUB_STEP_SUMMARY || echo "âŒ CNAME missing" >> $GITHUB_STEP_SUMMARY
        test -d dist/assets && echo "âœ… assets directory exists" >> $GITHUB_STEP_SUMMARY || echo "âŒ assets directory missing" >> $GITHUB_STEP_SUMMARY
        
    - name: ðŸ“Š Analyze bundle size
      run: |
        echo "## Bundle Size Analysis ðŸ“¦" >> $GITHUB_STEP_SUMMARY
        du -sh dist/* >> $GITHUB_STEP_SUMMARY
        echo "### Gzipped sizes:" >> $GITHUB_STEP_SUMMARY
        gzip -c dist/assets/features-*.js | wc -c | xargs -I {} echo "Features bundle: {} bytes" >> $GITHUB_STEP_SUMMARY
        gzip -c dist/assets/index-*.css | wc -c | xargs -I {} echo "CSS bundle: {} bytes" >> $GITHUB_STEP_SUMMARY
      continue-on-error: true
      
    - name: ðŸ” Run Lighthouse audit
      run: |
        npm run serve &
        sleep 10
        npm run performance:audit:ci
        pkill -f "python3 -m http.server"
      continue-on-error: true
      
    - name: ðŸ“± Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        cname: tonetracker.app
        force_orphan: true
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: 'ðŸš€ Deploy ToneTracker v${{ github.sha }}'
        enable_jekyll: false
        allow_empty_commit: false
        
    - name: ðŸ“ˆ Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: dist
        path: dist/
        retention-days: 30
        
    - name: ðŸ“Š Upload Lighthouse report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: lighthouse-report
        path: lighthouse-report.html
        retention-days: 7

  # Notify deployment status
  notify:
    runs-on: ubuntu-latest
    name: ðŸ“¢ Deployment Notification
    needs: [deploy]
    if: always() && github.ref == 'refs/heads/main'
    
    steps:
    - name: ðŸŽ‰ Success notification
      if: needs.deploy.result == 'success'
      run: |
        echo "## âœ… Deployment Successful! ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "ToneTracker has been successfully deployed to production." >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŒ Live URL: https://tonetracker.app" >> $GITHUB_STEP_SUMMARY
        
    - name: âŒ Failure notification
      if: needs.deploy.result == 'failure'
      run: |
        echo "## âŒ Deployment Failed ðŸ’¥" >> $GITHUB_STEP_SUMMARY
        echo "Please check the deployment logs and fix any issues." >> $GITHUB_STEP_SUMMARY

